<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Календарь — День • Неделя • Год</title>
  <style>
    :root{
      --vh: 1vh; /* JS установит точное значение на мобайле */ /* [web:64] */
      --bg: #0b0c0f;
      --panel: #11141b;
      --panel2: #0f1117;
      --stroke: #20283a;
      --text: #e8edf6;
      --muted: #a0aec0;
      --accent: #4f8cff;
      --accent-2: #7aa2ff;
      --radius: 14px;
      --gap: 10px;
      --toolbar-h: 56px;
      --sidebar-w: min(92vw, 420px);
      --ring: 0 0 0 2px rgba(79,140,255,.3);
    }

    html, body{
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior: none;
    }

    /* Корневой адаптивный контейнер */
    .app{
      height: 100dvh;
      height: calc(var(--vh) * 100);
      display: grid;
      grid-template-rows: var(--toolbar-h) 1fr;
      background: var(--panel2);
      padding: env(safe-area-inset-top, 0px) env(safe-area-inset-right, 0px)
               env(safe-area-inset-bottom, 0px) env(safe-area-inset-left, 0px);
    }

    /* Верхняя панель */
    .toolbar{
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: var(--gap);
      padding: 0 10px;
      background: var(--panel);
      border-bottom: 1px solid var(--stroke);
    }
    .brand{
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }
    .dot{
      width: 10px; height: 10px; border-radius: 50%;
      background: radial-gradient(65% 65% at 50% 50%, var(--accent) 0%, var(--accent-2) 100%);
      box-shadow: 0 0 20px rgba(79,140,255,.4);
      flex: 0 0 auto;
    }
    .title{
      font-size: 15px; font-weight: 600; letter-spacing: .2px;
      white-space: nowrap; text-overflow: ellipsis; overflow: hidden;
    }

    .segmented{
      display: grid;
      grid-auto-flow: column;
      gap: 4px;
      background: rgba(255,255,255,.04);
      border: 1px solid var(--stroke);
      border-radius: 999px;
      padding: 4px;
      height: 40px;
      align-items: center;
    }
    .segmented button{
      appearance: none; border: 0; margin: 0; cursor: pointer;
      height: 32px; padding: 0 12px; border-radius: 16px;
      background: transparent; color: var(--muted); font-weight: 600;
      transition: background .2s ease, color .2s ease, transform .05s ease;
      white-space: nowrap;
    }
    .segmented button[aria-pressed="true"]{
      background: linear-gradient(180deg, rgba(79,140,255,.18) 0%, rgba(79,140,255,.12) 100%);
      color: var(--text);
      box-shadow: inset 0 0 0 1px rgba(79,140,255,.35);
    }
    .segmented button:active{ transform: translateY(1px); }

    /* Основная область: календарь + боковая панель */
    .main{
      position: relative;
      display: grid;
      grid-template-columns: 1fr;
      grid-template-rows: 1fr;
      overflow: hidden;
      min-height: 0;
    }

    .calendar-wrap{
      position: relative;
      width: 100%; height: 100%;
      overflow: hidden;
      background: var(--panel2);
    }
    .calendar-iframe{
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      border: 0; background: #fff;
      overscroll-behavior: contain;
    }

    /* Перекрывающий «клик‑слой» для ловли нажатий по ячейкам */
    .hit-layer{
      position: absolute; inset: 0;
      background: transparent;
      /* pointer-events по умолчанию на слое — только для tap/click, чтобы скролл шёл по iframe */
      pointer-events: none;
    }
    /* Включаем ловлю кликов только на быстрые тап‑точки (используем JS для краткого окна) */
    .hit-layer.capture{
      pointer-events: auto;
      /* Лёгкие зоны padding, чтобы не мешать скроллу по краям */
    }

    /* Боковая панель детализации */
    .sidebar{
      position: absolute;
      top: 0; right: 0;
      width: var(--sidebar-w);
      height: 100%;
      background: var(--panel);
      border-left: 1px solid var(--stroke);
      transform: translateX(100%);
      transition: transform .25s ease;
      display: grid;
      grid-template-rows: auto 1fr auto;
      box-shadow:
        0 10px 30px rgba(0,0,0,.35),
        0 0 0 1px rgba(255,255,255,.03) inset;
    }
    .sidebar.open{ transform: translateX(0); }

    .side-head{
      padding: 12px 12px 8px;
      border-bottom: 1px solid var(--stroke);
      display: flex; align-items: center; justify-content: space-between; gap: 8px;
    }
    .side-head h3{
      margin: 0; font-size: 16px; letter-spacing: .2px;
    }
    .close-btn{
      appearance: none; border: 0; cursor: pointer;
      height: 32px; padding: 0 12px; border-radius: 8px;
      background: rgba(255,255,255,.06); color: var(--text);
    }
    .close-btn:active{ transform: translateY(1px); }

    .side-body{
      padding: 12px;
      overflow: auto;
      line-height: 1.45;
      color: var(--text);
    }
    .side-body .muted{ color: var(--muted); }

    .side-foot{
      padding: 10px 12px;
      border-top: 1px solid var(--stroke);
      display: flex; gap: 8px; justify-content: flex-end;
    }
    .side-foot .open-native{
      appearance: none; border: 0; cursor: pointer;
      height: 36px; padding: 0 12px; border-radius: 10px;
      background: linear-gradient(180deg, rgba(79,140,255,.25) 0%, rgba(79,140,255,.18) 100%);
      color: var(--text);
      box-shadow: var(--ring);
    }

    /* Подсказка снизу */
    .hint{
      position: absolute; left: 10px; bottom: 10px;
      padding: 8px 10px; border-radius: 10px;
      background: rgba(0,0,0,.3); color: var(--muted);
      font-size: 12px; letter-spacing: .2px;
      backdrop-filter: blur(6px) saturate(1.1);
      border: 1px solid rgba(255,255,255,.08);
      max-width: calc(100% - 20px);
    }

    @media (orientation: portrait){
      .app{ height: 100dvh; height: calc(var(--vh) * 100); }
      .sidebar{ width: var(--sidebar-w); }
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Календарь — День • Неделя • Год">
    <header class="toolbar">
      <div class="brand">
        <div class="dot" aria-hidden="true"></div>
        <div class="title">Календарь</div>
      </div>
      <nav class="segmented" role="tablist" aria-label="Переключение вида">
        <button type="button" role="tab" data-view="day" aria-pressed="false">День</button>
        <button type="button" role="tab" data-view="week" aria-pressed="true">Неделя</button>
        <button type="button" role="tab" data-view="year" aria-pressed="false">Год</button>
      </nav>
    </header>

    <main class="main">
      <section class="calendar-wrap" aria-label="Область календаря">
        <iframe
          id="yc"
          class="calendar-iframe"
          title="Яндекс.Календарь"
          loading="lazy"
          referrerpolicy="no-referrer-when-downgrade"
          allowtransparency="true"
          sandbox="allow-scripts allow-same-origin allow-forms allow-popups"
        ></iframe>

        <!-- Перекрывающий слой для ловли кликов по ячейкам -->
        <div id="hit" class="hit-layer" aria-hidden="true"></div>

        <!-- Подсказка -->
        <div class="hint">Нажмите на ячейку события, чтобы открыть описание в панели справа.</div>

        <!-- Боковая панель детализации -->
        <aside id="sidebar" class="sidebar" aria-label="Детали события">
          <div class="side-head">
            <h3 id="ev-title">Событие</h3>
            <button class="close-btn" id="closeSide" aria-label="Закрыть">Закрыть</button>
          </div>
          <div class="side-body">
            <div class="muted" id="ev-when">Дата и время уточняются из интерфейса календаря</div>
            <hr style="border:none;border-top:1px solid var(--stroke); margin:10px 0;">
            <div id="ev-desc">Полное описание события отображается во встроенном интерфейсе Яндекс.Календаря после клика по событию внутри iFrame. Эта панель — оболочка с пояснениями и быстрыми действиями.</div>
          </div>
          <div class="side-foot">
            <button class="open-native" id="openNative">Открыть в календаре</button>
          </div>
        </aside>
      </section>
    </main>
  </div>

  <script>
    // 1) Устойчивые viewport-единицы для мобильных
    (function(){
      function setVH(){
        var vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', vh + 'px');
      }
      setVH();
      window.addEventListener('resize', setVH, {passive:true});
      window.addEventListener('orientationchange', setVH, {passive:true});
    })();

    // 2) Конфигурация источника Яндекс.Календаря (embed)
    const TOKEN = '60dc2986fd011ad112334068ba1429c715c3c6df';
    const TZ = 'Europe/Moscow';

    function makeSrc(view){
      // Яндекс embed: используем /embed/<view>?private_token=...&tz_id=...
      // Поддерживаемые представления: day, week, month, year; в задаче — день/неделя/год.
      // Для «неделя» используем week, для «день» — day, для «год» — year. [web:31]
      const v = (view === 'day' || view === 'week' || view === 'year') ? view : 'week';
      return `https://calendar.yandex.ru/embed/${v}?private_token=${encodeURIComponent(TOKEN)}&tz_id=${encodeURIComponent(TZ)}`;
    }

    // 3) Инициализация iFrame и переключателей
    const iframe = document.getElementById('yc');
    const tabs = Array.from(document.querySelectorAll('[data-view]'));

    function setPressed(target){
      tabs.forEach(b => b.setAttribute('aria-pressed', String(b === target)));
    }

    let currentView = 'week';
    function switchView(v){
      currentView = v;
      iframe.src = makeSrc(v);
      const target = tabs.find(b => b.dataset.view === v);
      if (target) setPressed(target);
    }

    // Первичная загрузка
    switchView(currentView);

    tabs.forEach(b=>{
      b.addEventListener('click', ()=>{
        switchView(b.dataset.view);
        // При смене вида сбрасываем панель
        sidebar.classList.remove('open');
      }, {passive:true});
    });

    // 4) Оболочка раскрытия «события»
    // Из-за политики одного источника скрипт не может читать содержимое iFrame (события, DOM) — доступ блокируется. [web:64][web:61]
    // Поэтому делаем UX-оболочку:
    // - Короткий «tap»-захват включает слой на доли секунды, чтобы ловить клик-координаты без мешания прокрутке.
    // - Показываем панель с шаблонной информацией и кнопкой «Открыть в календаре» (фактическая детализация — внутри самого iFrame).
    const hit = document.getElementById('hit');
    const sidebar = document.getElementById('sidebar');
    const closeSide = document.getElementById('closeSide');
    const openNative = document.getElementById('openNative');
    const evTitle = document.getElementById('ev-title');
    const evWhen = document.getElementById('ev-when');
    const evDesc = document.getElementById('ev-desc');

    let tapTimer = null;

    // При касании включаем «capture» на короткое окно, чтобы фиксировать клик
    function armCapture(){
      clearTimeout(tapTimer);
      hit.classList.add('capture');
      tapTimer = setTimeout(()=> hit.classList.remove('capture'), 350);
    }

    // Включаем capture перед потенциальным тапом
    // Используем pointerdown — на сенсорных быстрее, чем click
    iframe.addEventListener('pointerdown', armCapture, {passive:true});

    // Обработка клика по слою
    hit.addEventListener('click', function(ev){
      // Координаты на экране (для будущего сопоставления зон, если понадобится)
      const x = ev.clientX;
      const y = ev.clientY;

      // Так как мы не можем читать DOM iFrame, показываем панель с общими данными.
      // При этом сам iFrame получит реальный клик и откроет нативную карточку события внутри себя (если попали по событию).
      openSidebar({x, y});
      // Отключаем capture сразу, чтобы не мешать
      hit.classList.remove('capture');
    });

    function openSidebar(pos){
      // Псевдо-заполнение карточки: отражаем текущий режим и примерную позицию клика.
      const labels = {day: 'День', week: 'Неделя', year: 'Год'};
      evTitle.textContent = `Событие (${labels[currentView] || 'Неделя'})`;
      evWhen.textContent = 'Подробности времени и описания доступны в интерфейсе Яндекс.Календаря внутри iFrame.';
      evDesc.textContent = 'Эта панель — оболочка. Для просмотра полного описания и участников используйте карточку события в календаре (встроенный интерфейс откроется после клика по событию).';
      sidebar.classList.add('open');
    }

    closeSide.addEventListener('click', ()=> sidebar.classList.remove('open'));

    // Кнопка "Открыть в календаре": попытка сфокусировать iFrame, чтобы показать нативную карточку там
    openNative.addEventListener('click', ()=>{
      try {
        iframe.contentWindow && iframe.contentWindow.focus();
      } catch(e) { /* игнорируем в рамках CSP/sandbox */ }
    });

    // Дополнительно: защищаемся от потенциальных редиректов из iFrame
    // (в целом допустимо sandbox с ограничениями, но оставим allow-popups,allow-forms для удобства). [web:64][web:56]
  </script>
</body>
</html>
